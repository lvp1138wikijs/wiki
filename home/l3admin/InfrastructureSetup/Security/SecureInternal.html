<!--
title: Secure Internal Servers
description: 
published: true
date: 2021-12-23T22:30:14.225Z
tags: 
editor: ckeditor
dateCreated: 2021-05-19T19:46:56.804Z
-->

<h1>Secure Internal Servers</h1>
<h5>Secure the SSH Service</h5>
<p>&nbsp;</p>
<pre><code class="language-plaintext">useradd -s /bin/bash -d /home/pcruz -m -G wheel pcruz
passwd pcruz
  
sed -i 's/#Port 22/Port 5252/g' /etc/ssh/sshd_config
sed -i 's/#Protocol 2/Protocol 2/g' /etc/ssh/sshd_config
sed -i 's/#PermitRootLogin yes/PermitRootLogin no/g' /etc/ssh/sshd_config
sed -i '/PermitRootLogin no/a AllowUsers pcruz' /etc/ssh/sshd_config
  
cat &gt;&gt; /etc/sudoers &lt;&lt;END
pcruz ALL=(ALL) ALL
END
 
systemctl restart sshd

cat &gt;&gt; /root/.bashrc &lt;&lt;END
export PS1='\[\e[1;31m\][\u@\h \W]\$\[\e[0m\] '
END
</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h5>Set IPtables Firewall Rules to Enable SSH Access Only through VPN</h5>
<p>All our internal servers ssh access is limited through VPN ips only. We use OpenVPN. You can check this tutorial on how to set up an OpenVPN access server.</p>
<p>Install IPTables and clear the default rules</p>
<pre><code class="language-plaintext">yum install iptables-services -y
systemctl enable iptables
iptables -F
iptables -X</code></pre>
<p>&nbsp;</p>
<h5>IPtables Rules for API Server</h5>
<p>&nbsp;</p>
<pre><code class="language-plaintext">&gt;/etc/sysconfig/iptables
cat &gt;&gt; /etc/sysconfig/iptables &lt;&lt;END
# Generated by iptables-save v1.4.21 on Wed May 19 16:34:54 2021
*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -s 64.235.41.50/32 -p tcp -m tcp --dport 5252 -m comment --comment "SSH Enabled on SGP vpn " -j ACCEPT
-A INPUT -s 167.99.160.171/32 -p tcp -m tcp --dport 5252 -m comment --comment "SSH Enabled on US vpn " -j ACCEPT
-A INPUT -s 64.235.37.226/32 -p tcp -m tcp --dport 5252 -m comment --comment "SSH Enabled on AMS vpn " -j ACCEPT
-A INPUT -s 64.235.50.5/32 -p tcp -m tcp --dport 5252 -m comment --comment "SSH Enabled on LAS_Ded vpn" -j ACCEPT
-A INPUT -s 72.18.207.150/32 -p tcp -m tcp --dport 5252 -m comment --comment "API-V2" -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -m comment --comment "Apache Port" -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -m comment --comment "Apache SSL Port" -j ACCEPT
-A INPUT -s 64.235.55.60,64.235.55.61 -p tcp -m tcp --dport 3305 -j ACCEPT -m comment --comment "MySQL Server"
-A INPUT -s 72.18.207.240 -m multiport -p tcp --dports 9101:9103 -j ACCEPT -m comment --comment "For Bacula"
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT -m comment --comment "Ping"
-A INPUT -i lo -j ACCEPT
COMMIT
# Completed on Wed May 19 16:34:54 2021
END</code></pre>
<p>&nbsp;</p>
<h5>IPtables Rules for Bridge Servers</h5>
<p><i><mark class="marker-yellow">Note: Replace bond0.XX with correct interface name of the server</mark></i></p>
<pre><code class="language-plaintext">iptables -A INPUT -m state --state NEW -p udp -m multiport --dports 5404,5405 -j ACCEPT
iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 2224 -j ACCEPT
iptables -A INPUT -p igmp -j ACCEPT
iptables -A INPUT -m addrtype --dst-type MULTICAST -j ACCEPT
iptables -A INPUT -m addrtype --dst-type MULTICAST -j ACCEPT
iptables -A FORWARD -i bond0.2 -j ACCEPT
iptables -t nat -A POSTROUTING -o bond0.207 -j MASQUERADE</code></pre>
<p>&nbsp;</p>
<h5>IPtables Rules for &nbsp;Ticket/Secure.Serverpoint &nbsp;Servers</h5>
<p><i><mark class="marker-yellow">Note: Replace bond0.XX with correct interface name of the server</mark></i></p>
<pre><code class="language-plaintext">&gt;/etc/sysconfig/iptables
cat &gt;&gt; /etc/sysconfig/iptables &lt;&lt;END
# Generated by iptables-save v1.4.21 on Thu Jul  8 10:21:27 2021
*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-N FILTER_INPUT_BACKUP_ADMIN
-A INPUT -p tcp --dport 9102 -j FILTER_INPUT_BACKUP_ADMIN
-A INPUT -p tcp --dport 1167 -j FILTER_INPUT_BACKUP_ADMIN
-A FILTER_INPUT_BACKUP_ADMIN -s 72.18.207.240 -j ACCEPT
-A INPUT -s 64.235.41.50,64.235.37.226,64.235.50.5 -p tcp -m tcp --dport 5252  -j ACCEPT -m comment --comment "SSH Enabled on vpn servers"
-A INPUT -p tcp -s 72.18.207.240 --dport 1167 -j ACCEPT -m comment --comment "CDP Enabled From R1soft"
#-A INPUT -m multiport -p tcp --dports 80,443 -j ACCEPT  -m comment --comment "Apache Ports"
-A INPUT -p tcp -m tcp -s 72.18.207.240 --dport 9102 -m comment --comment "Bacula backup server" -j ACCEPT
-A INPUT -s 64.235.55.60,64.235.55.61 -p tcp -m tcp --dport 3305 -j ACCEPT -m comment --comment "MySQL Server"
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT -m comment --comment "For Ping"
-N FILTER_Apache
-A INPUT -m multiport -p tcp --dports 80,443 -j FILTER_Apache
-A FILTER_Apache -s 64.235.32.0/19 -j ACCEPT
-A FILTER_Apache -s 72.18.192.0/20 -j ACCEPT
-A FILTER_Apache -s 216.108.224.0/20 -j ACCEPT
-A FILTER_Apache -s 173.245.48.0/20 -j ACCEPT
-A FILTER_Apache -s 103.21.244.0/22 -j ACCEPT
-A FILTER_Apache -s 103.22.200.0/22 -j ACCEPT
-A FILTER_Apache -s 103.31.4.0/22 -j ACCEPT
-A FILTER_Apache -s 141.101.64.0/18 -j ACCEPT
-A FILTER_Apache -s 108.162.192.0/18 -j ACCEPT
-A FILTER_Apache -s 190.93.240.0/20 -j ACCEPT
-A FILTER_Apache -s 188.114.96.0/20 -j ACCEPT
-A FILTER_Apache -s 197.234.240.0/22 -j ACCEPT
-A FILTER_Apache -s 198.41.128.0/17 -j ACCEPT
-A FILTER_Apache -s 162.158.0.0/15 -j ACCEPT
-A FILTER_Apache -s 104.16.0.0/13 -j ACCEPT
-A FILTER_Apache -s 104.24.0.0/14 -j ACCEPT
-A FILTER_Apache -s 172.64.0.0/13 -j ACCEPT
-A FILTER_Apache -s 131.0.72.0/22 -j ACCEPT
-A FILTER_Apache -s 10.255.0.0/24 -j ACCEPT
-A FILTER_Apache -s 95.216.64.250 -j ACCEPT
-A FILTER_Apache -s 190.104.217.135 -j ACCEPT
-A FILTER_Apache -s 144.48.37.241 -j ACCEPT
-A FILTER_Apache -s 104.247.192.170 -j ACCEPT
-A FILTER_Apache -s 136.175.8.15 -j ACCEPT
-A FILTER_Apache -s 107.161.26.107 -j ACCEPT
-A FILTER_Apache -s 172.105.6.187 -j ACCEPT
-A FILTER_Apache -s 173.248.161.42 -j ACCEPT
-A FILTER_Apache -s 66.11.113.250 -j ACCEPT
-A FILTER_Apache -s 172.93.197.58 -j ACCEPT
-A FILTER_Apache -s 172.82.138.70 -j ACCEPT
-A FILTER_Apache -s 209.205.207.243 -j ACCEPT
-A FILTER_Apache -s 66.23.202.26 -j ACCEPT
-A FILTER_Apache -s 64.79.76.50 -j ACCEPT
-A FILTER_Apache -s 208.82.130.170 -j ACCEPT
-A FILTER_Apache -s 192.154.102.130 -j ACCEPT
-A FILTER_Apache -s 5.226.139.158 -j ACCEPT
-A FILTER_Apache -s 195.154.167.97 -j ACCEPT
-A FILTER_Apache -s 217.182.201.227 -j ACCEPT
-A FILTER_Apache -s 37.252.125.64 -j ACCEPT
-A FILTER_Apache -s 54.36.110.96 -j ACCEPT
-A FILTER_Apache -s 78.110.173.218 -j ACCEPT
-A FILTER_Apache -s 112.213.38.162 -j ACCEPT
-A FILTER_Apache -s 172.104.181.238 -j ACCEPT
-A FILTER_Apache -s 103.6.85.58 -j ACCEPT
-A FILTER_Apache -s 180.149.230.17 -j ACCEPT
-A FILTER_Apache -s 203.29.240.44 -j ACCEPT
-A FILTER_Apache -s 163.47.21.47 -j ACCEPT
-A FILTER_Apache -s 54.232.120.40 -j ACCEPT
-A FILTER_Apache -s 162.254.202.35 -j ACCEPT
COMMIT
# Completed on Thu Jul  8 10:21:27 2021
END</code></pre>
<p>Before restart, recheck the rules added to /etc/sysconfig/iptables and make sure all rules are in proper order.&nbsp;</p>
<pre><code class="language-plaintext">service iptables restart</code></pre>
